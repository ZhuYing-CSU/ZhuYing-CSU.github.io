{"meta":{"title":"晓风昼影","subtitle":"","description":"记录日常笔记及思考","author":"一抹竹影","url":"https://zhuying-csu.github.io","root":"/"},"pages":[{"title":"文章归档","date":"2022-06-09T13:03:38.505Z","updated":"2022-06-09T13:03:38.505Z","comments":true,"path":"archive.html","permalink":"https://zhuying-csu.github.io/archive.html","excerpt":"","text":""}],"posts":[{"title":"Pytorch在Android端中的应用流程","slug":"Pytorch在Android端中的应用流程","date":"2022-06-09T06:53:00.000Z","updated":"2022-06-09T15:37:08.794Z","comments":true,"path":"2022/06/09/Pytorch在Android端中的应用流程/","link":"","permalink":"https://zhuying-csu.github.io/2022/06/09/Pytorch%E5%9C%A8Android%E7%AB%AF%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%E6%B5%81%E7%A8%8B/","excerpt":"","text":"模型预处理 在神经网络模型训练好后，需要使用jit中的script函数将模型转为Torchscript语言，然后再用optimize_for_mobile函数对其进行优化，最后再使用_save_for_lite_interpreter函数保存为可用于pytorch-lite的神经网络模型文件，代码如下： import torch from torch.utils.mobile_optimizer import optimize_for_mobile model.eval() # assume model had loaded or trained # convert python to torchscript scripted_model = torch.jit.script(model) optimized_scripted_model = optimize_for_mobile(scripted_model) optimized_scripted_model._save_for_lite_interpreter(\"your_file.tpl\") Android Project build.gradle 设置 在dependencies一项中加入下列内容 // Pytorch-lite framework (ver: 1.9.0) implementation 'org.pytorch:pytorch_android_lite:1.9.0' implementation 'org.pytorch:pytorch_android_torchvision:1.9.0' 模型使用 读取模型 Module yourModel = LiteModuleLoader.load(modelFilePath); 读取图片 如果没有特别的需要的话，直接用Bitmap去读取图像文件即可。 Bitmap img = BitmapFactory.decodeFile(imgFilePath); 模型使用 Tensor input = TensorImageUtils.bitmapToFloat32Tensor( originalImg, TensorImageUtils.TORCHVISION_NORM_MEAN_RGB, TensorImageUtils.TORCHVISION_NORM_STD_RGB ); Tensor output = nnModel.forward(IValue.from(input)).toTensor(); 上述代码中，将Bitmap类型转换为Tensor类型时做了normalization的预处理，但可以不做。 模型输出转换为图片 由于模型的输出类型为Tensor，若需要使用opencv的Mat类型的话，需要依次转换格式为FloatArray，FloatBuffer，ByteBuffer，最后到Mat，相关代码如下所示。 private static ByteBuffer FloatBuffer2ByteBuffer(FloatBuffer originBuffer) { ByteBuffer ret = ByteBuffer.allocateDirect(originBuffer.remaining() * 64); ret.order(ByteOrder.nativeOrder()); originBuffer.mark(); ret.asFloatBuffer().put(originBuffer); originBuffer.reset(); ret.rewind(); return ret; } private static Mat byteArray2Mat(ByteBuffer byteBuffer, int width, int height) { return new Mat(width, height, CvType.CV_64FC3, byteBuffer); } private static Mat Tensor2Mat(Tensor input) { return byteArray2Mat( FloatBuffer2ByteBuffer(FloatBuffer.wrap(input.getDataAsFloatArray())), (int) input.shape()[2], (int) input.shape()[3] ); }","categories":[],"tags":[{"name":"Android","slug":"Android","permalink":"https://zhuying-csu.github.io/tags/Android/"},{"name":"Java","slug":"Java","permalink":"https://zhuying-csu.github.io/tags/Java/"},{"name":"Pytorch","slug":"Pytorch","permalink":"https://zhuying-csu.github.io/tags/Pytorch/"},{"name":"Deep Learning","slug":"Deep-Learning","permalink":"https://zhuying-csu.github.io/tags/Deep-Learning/"}]},{"title":"Makefile Helper","slug":"Makefile-Helper","date":"2022-06-08T14:52:07.000Z","updated":"2022-06-09T13:17:47.599Z","comments":true,"path":"2022/06/08/Makefile-Helper/","link":"","permalink":"https://zhuying-csu.github.io/2022/06/08/Makefile-Helper/","excerpt":"","text":".PHONY: test help target_name: ## it is the description @echo \"do nothing\" help: @grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN &#123;FS = \":.*?## \"&#125;; &#123;printf \"\\033[36m%-30s\\033[0m %s\\n\", $$1, $$2&#125;'","categories":[],"tags":[{"name":"make","slug":"make","permalink":"https://zhuying-csu.github.io/tags/make/"},{"name":"Makefile","slug":"Makefile","permalink":"https://zhuying-csu.github.io/tags/Makefile/"}]}],"categories":[],"tags":[{"name":"Android","slug":"Android","permalink":"https://zhuying-csu.github.io/tags/Android/"},{"name":"Java","slug":"Java","permalink":"https://zhuying-csu.github.io/tags/Java/"},{"name":"Pytorch","slug":"Pytorch","permalink":"https://zhuying-csu.github.io/tags/Pytorch/"},{"name":"Deep Learning","slug":"Deep-Learning","permalink":"https://zhuying-csu.github.io/tags/Deep-Learning/"},{"name":"make","slug":"make","permalink":"https://zhuying-csu.github.io/tags/make/"},{"name":"Makefile","slug":"Makefile","permalink":"https://zhuying-csu.github.io/tags/Makefile/"}]}